const saml = require('saml2-js');

module.exports = async (req, res) => {

    const sp_options = {
        entity_id: "http://localhost:4000/",
        private_key: process.env.CERT,
        certificate: process.env.KEY,
        assert_endpoint: "http://localhost:3000/samlProvider/"
      };
    const sp = new saml2.ServiceProvider(sp_options);

    const idp_options = {
        sso_login_url: "http://localhost:3000/samlProvider",
        sso_logout_url: "http://localhost:3000/samlProvider",
        certificates: process.env.IDP_CERT,
        force_authn: true,
        sign_get_request: false,
        allow_unencrypted_assertion: false
    }
    const idp = new saml2.IdentityProvider(idp_options);

    var options = {request_body: req.body};
    sp.post_assert(idp, options, function(err, saml_response) {
      if (err != null)
        return res.send(500);

      res.send("Hello #{saml_response.user.name_id}!");
    });
}